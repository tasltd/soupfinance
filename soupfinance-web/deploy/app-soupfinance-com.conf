# Apache virtual host for SoupFinance App (app.soupfinance.com)
#
# Architecture:
#   Cloudflare -> Apache -> Static files (frontend)
#                       -> Proxy API to tas.soupmarkets.com (backend)
#
# IMPORTANT:
# - Site is ONLY accessible via domain name, NOT via direct IP
# - API calls are proxied to tas.soupmarkets.com (production soupmarkets tenant)
# - Api-Authorization header authenticates this app with the backend ApiConsumer
#
# DNS: app.soupfinance.com -> Cloudflare -> Origin server (65.20.112.224)
# Backend: tas.soupmarkets.com (remote backend, TAS tenant)
#
# Required Apache modules:
#   a2enmod proxy proxy_http headers rewrite ssl

<VirtualHost *:80>
    ServerName app.soupfinance.com

    # Serve static files from /var/www/soupfinance
    DocumentRoot /var/www/soupfinance

    <Directory /var/www/soupfinance>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Handle SPA routing - serve index.html for non-existent paths
        # Skip API routes which should be proxied to backend
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} !^/rest
        RewriteCond %{REQUEST_URI} !^/application
        RewriteCond %{REQUEST_URI} !^/client
        RewriteCond %{REQUEST_URI} !^/account
        RewriteRule . /index.html [L]
    </Directory>

    # ========================================
    # Proxy API calls to tas.soupmarkets.com
    # ========================================
    # tas.soupmarkets.com is the production soupmarkets backend tenant
    # that serves the SoupFinance API

    SSLProxyEngine On
    ProxyPreserveHost Off
    ProxyRequests Off

    # Added: Api-Authorization header to authenticate with backend ApiConsumer
    RequestHeader set Api-Authorization "Basic U291cEZpbmFuY2UgV2ViIEFwcDpkMzc5YTFkN2I4MGExYzA3MmFjMzc0MDIwY2VmYmMwNQ=="

    # REST API endpoints
    ProxyPass /rest https://tas.soupmarkets.com/rest
    ProxyPassReverse /rest https://tas.soupmarkets.com/rest

    # Application status/health endpoints
    ProxyPass /application https://tas.soupmarkets.com/application
    ProxyPassReverse /application https://tas.soupmarkets.com/application

    # Client endpoints
    ProxyPass /client https://tas.soupmarkets.com/client
    ProxyPassReverse /client https://tas.soupmarkets.com/client

    # Account/registration endpoints
    ProxyPass /account https://tas.soupmarkets.com/account
    ProxyPassReverse /account https://tas.soupmarkets.com/account

    # Forward original client info to backend
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Host "app.soupfinance.com"
    RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/app.soupfinance.com-error.log
    CustomLog ${APACHE_LOG_DIR}/app.soupfinance.com-access.log combined
</VirtualHost>

# HTTPS VirtualHost for Cloudflare Full SSL
<VirtualHost *:443>
    ServerName app.soupfinance.com

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/app.soupfinance.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/app.soupfinance.com/privkey.pem

    # Serve static files from /var/www/soupfinance
    DocumentRoot /var/www/soupfinance

    <Directory /var/www/soupfinance>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Handle SPA routing - serve index.html for non-existent paths
        # Skip API routes which should be proxied to backend
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} !^/rest
        RewriteCond %{REQUEST_URI} !^/application
        RewriteCond %{REQUEST_URI} !^/client
        RewriteCond %{REQUEST_URI} !^/account
        RewriteRule . /index.html [L]
    </Directory>

    # Proxy API calls to tas.soupmarkets.com
    SSLProxyEngine On
    ProxyPreserveHost Off
    ProxyRequests Off

    # Added: Api-Authorization header to authenticate with backend ApiConsumer
    RequestHeader set Api-Authorization "Basic U291cEZpbmFuY2UgV2ViIEFwcDpkMzc5YTFkN2I4MGExYzA3MmFjMzc0MDIwY2VmYmMwNQ=="

    ProxyPass /rest https://tas.soupmarkets.com/rest
    ProxyPassReverse /rest https://tas.soupmarkets.com/rest

    ProxyPass /application https://tas.soupmarkets.com/application
    ProxyPassReverse /application https://tas.soupmarkets.com/application

    ProxyPass /client https://tas.soupmarkets.com/client
    ProxyPassReverse /client https://tas.soupmarkets.com/client

    ProxyPass /account https://tas.soupmarkets.com/account
    ProxyPassReverse /account https://tas.soupmarkets.com/account

    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Host "app.soupfinance.com"

    ErrorLog ${APACHE_LOG_DIR}/app.soupfinance.com-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/app.soupfinance.com-ssl-access.log combined
</VirtualHost>
