# Apache virtual host for SoupFinance App (app.soupfinance.com)
#
# Architecture:
#   Cloudflare -> Apache -> Static files (frontend)
#                       -> Proxy API to tas.soupmarkets.com (backend)
#
# IMPORTANT:
# - Site is ONLY accessible via domain name, NOT via direct IP
# - API calls are proxied to tas.soupmarkets.com (production soupmarkets tenant)
# - Api-Authorization header authenticates this app with the backend ApiConsumer
#
# DNS: app.soupfinance.com -> Cloudflare -> Origin server (65.20.112.224)
# Backend: tas.soupmarkets.com (remote backend, TAS tenant)
#
# Required Apache modules:
#   a2enmod proxy proxy_http headers rewrite ssl
#
# ===========================================================================
# CRITICAL RULES FOR THIS CONFIG (READ BEFORE EDITING):
# ===========================================================================
#
# 1. TRAILING SLASHES ON ALL PROXY PATHS AND REWRITE EXCLUSIONS
#    Without trailing slashes, Apache prefix-matches too broadly:
#      ProxyPass /client   catches /client/index.json AND /clients/new (WRONG!)
#      ProxyPass /client/  catches /client/index.json ONLY (CORRECT)
#    Same for RewriteCond exclusions:
#      !^/client   excludes /clients/new from SPA routing -> 404 (WRONG!)
#      !^/client/  excludes /client/index.json only (CORRECT)
#    This applies to ALL proxy paths: /rest/, /client/, /account/, /application/
#
# 2. BOTH VHOST BLOCKS (80 + 443) MUST BE IDENTICAL
#    Rewrite rules, proxy paths, headers — must match in both blocks.
#    Only SSL directives differ.
#
# 3. Api-Authorization HEADER IN BOTH BLOCKS
#    Must be present in BOTH port 80 and port 443 VHost blocks.
#
# 4. THIS FILE IS THE CANONICAL SOURCE
#    deploy-to-production.sh uploads THIS file to the server.
#    Do NOT edit other .conf files expecting them to be deployed.
# ===========================================================================

<VirtualHost *:80>
    ServerName app.soupfinance.com

    # Serve static files from /var/www/soupfinance
    DocumentRoot /var/www/soupfinance

    <Directory /var/www/soupfinance>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Handle SPA routing - serve index.html for non-existent paths
        # Skip API routes which should be proxied to backend
        #
        # CRITICAL: All proxy path exclusions MUST use trailing slashes!
        # Without trailing slashes, prefix matching catches SPA routes:
        #   !^/client  matches /clients/new (SPA route) -> proxied to backend -> 404
        #   !^/client/ matches /client/index.json (API) but NOT /clients/new (SPA)
        # Same applies to /account vs /accounts, /application vs /applications, etc.
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} !^/rest/
        RewriteCond %{REQUEST_URI} !^/application/
        RewriteCond %{REQUEST_URI} !^/client/
        RewriteCond %{REQUEST_URI} !^/account/
        RewriteRule . /index.html [L]
    </Directory>

    # Custom error pages for backend unavailability
    ErrorDocument 502 /maintenance.html
    ErrorDocument 503 /maintenance.html
    ErrorDocument 504 /maintenance.html

    # ========================================
    # Proxy API calls to tas.soupmarkets.com
    # ========================================
    # tas.soupmarkets.com is the production soupmarkets backend tenant
    # that serves the SoupFinance API
    #
    # CRITICAL: All ProxyPass paths MUST use trailing slashes!
    # Without trailing slashes, Apache prefix-matches too broadly:
    #   ProxyPass /client  proxies BOTH /client/index.json AND /clients/new
    #   ProxyPass /client/ proxies ONLY  /client/index.json (correct)
    # SPA routes like /clients, /accounts must NOT be proxied.

    SSLProxyEngine On
    ProxyPreserveHost Off
    ProxyRequests Off
    ProxyTimeout 30

    # Api-Authorization header to authenticate with backend ApiConsumer
    RequestHeader set Api-Authorization "Basic U291cEZpbmFuY2UgV2ViIEFwcDpkMzc5YTFkN2I4MGExYzA3MmFjMzc0MDIwY2VmYmMwNQ=="

    # REST API endpoints (/rest/ prefix — all REST controllers)
    ProxyPass /rest/ https://tas.soupmarkets.com/rest/
    ProxyPassReverse /rest/ https://tas.soupmarkets.com/rest/

    # Application status/health endpoints
    ProxyPass /application/ https://tas.soupmarkets.com/application/
    ProxyPassReverse /application/ https://tas.soupmarkets.com/application/

    # Client endpoints (backend: /client/*, NOT /clients/*)
    # Fix: Trailing slash prevents matching SPA route /clients/*
    ProxyPass /client/ https://tas.soupmarkets.com/client/
    ProxyPassReverse /client/ https://tas.soupmarkets.com/client/

    # Account/registration endpoints (backend: /account/*, NOT /accounts/*)
    # Fix: Trailing slash prevents matching SPA route /accounts/*
    ProxyPass /account/ https://tas.soupmarkets.com/account/
    ProxyPassReverse /account/ https://tas.soupmarkets.com/account/

    # Forward original client info to backend
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Host "app.soupfinance.com"
    RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/app.soupfinance.com-error.log
    CustomLog ${APACHE_LOG_DIR}/app.soupfinance.com-access.log combined
</VirtualHost>

# ========================================
# HTTPS VirtualHost (SSL termination at origin)
# ========================================
# SSL VirtualHost for direct HTTPS connections (Cloudflare Full SSL mode)
# Uses Let's Encrypt certificate for app.soupfinance.com
<VirtualHost *:443>
    ServerName app.soupfinance.com

    # Serve static files from /var/www/soupfinance
    DocumentRoot /var/www/soupfinance

    <Directory /var/www/soupfinance>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Handle SPA routing - serve index.html for non-existent paths
        # Skip API routes which should be proxied to backend
        #
        # CRITICAL: All proxy path exclusions MUST use trailing slashes!
        # Without trailing slashes, prefix matching catches SPA routes:
        #   !^/client  matches /clients/new (SPA route) -> proxied to backend -> 404
        #   !^/client/ matches /client/index.json (API) but NOT /clients/new (SPA)
        # Same applies to /account vs /accounts, /application vs /applications, etc.
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} !^/rest/
        RewriteCond %{REQUEST_URI} !^/application/
        RewriteCond %{REQUEST_URI} !^/client/
        RewriteCond %{REQUEST_URI} !^/account/
        RewriteRule . /index.html [L]
    </Directory>

    # Custom error pages for backend unavailability
    ErrorDocument 502 /maintenance.html
    ErrorDocument 503 /maintenance.html
    ErrorDocument 504 /maintenance.html

    # Proxy API calls to tas.soupmarkets.com
    #
    # CRITICAL: All ProxyPass paths MUST use trailing slashes!
    # Without trailing slashes, Apache prefix-matches too broadly:
    #   ProxyPass /client  proxies BOTH /client/index.json AND /clients/new
    #   ProxyPass /client/ proxies ONLY  /client/index.json (correct)
    # SPA routes like /clients, /accounts must NOT be proxied.
    SSLProxyEngine On
    ProxyPreserveHost Off
    ProxyRequests Off
    ProxyTimeout 30

    # Api-Authorization header to authenticate with backend ApiConsumer
    RequestHeader set Api-Authorization "Basic U291cEZpbmFuY2UgV2ViIEFwcDpkMzc5YTFkN2I4MGExYzA3MmFjMzc0MDIwY2VmYmMwNQ=="

    # REST API endpoints (/rest/ prefix — all REST controllers)
    ProxyPass /rest/ https://tas.soupmarkets.com/rest/
    ProxyPassReverse /rest/ https://tas.soupmarkets.com/rest/

    # Application status/health endpoints
    ProxyPass /application/ https://tas.soupmarkets.com/application/
    ProxyPassReverse /application/ https://tas.soupmarkets.com/application/

    # Client endpoints (backend: /client/*, NOT /clients/*)
    # Fix: Trailing slash prevents matching SPA route /clients/*
    ProxyPass /client/ https://tas.soupmarkets.com/client/
    ProxyPassReverse /client/ https://tas.soupmarkets.com/client/

    # Account/registration endpoints (backend: /account/*, NOT /accounts/*)
    # Fix: Trailing slash prevents matching SPA route /accounts/*
    ProxyPass /account/ https://tas.soupmarkets.com/account/
    ProxyPassReverse /account/ https://tas.soupmarkets.com/account/

    # Forward original client info to backend
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Host "app.soupfinance.com"
    RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"

    # SSL configuration - Let's Encrypt certificate
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/app.soupfinance.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/app.soupfinance.com/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/app.soupfinance.com-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/app.soupfinance.com-ssl-access.log combined
</VirtualHost>
