# Apache virtual host for app.soupfinance.com
# Handles SSL termination and proxies to Nginx on port 8088

# HTTP to HTTPS redirect
<VirtualHost *:80>
    ServerName app.soupfinance.com

    RewriteEngine on
    RewriteCond %{SERVER_NAME} =app.soupfinance.com
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>

# HTTPS with SSL termination
<VirtualHost *:443>
    ServerName app.soupfinance.com
    ServerAdmin admin@soupfinance.com

    # SSL Configuration (will be added by certbot)
    SSLEngine on
    # SSLCertificateFile /etc/letsencrypt/live/app.soupfinance.com/fullchain.pem
    # SSLCertificateKeyFile /etc/letsencrypt/live/app.soupfinance.com/privkey.pem
    # Include /etc/letsencrypt/options-ssl-apache.conf

    # Proxy settings
    ProxyPreserveHost On
    ProxyRequests Off

    # Enable required proxy modules
    # Ensure these are enabled: a2enmod proxy proxy_http headers rewrite

    # Proxy all requests to Nginx
    ProxyPass / http://127.0.0.1:8088/
    ProxyPassReverse / http://127.0.0.1:8088/

    # Forward original client info
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/soupfinance-error.log
    CustomLog ${APACHE_LOG_DIR}/soupfinance-access.log combined
</VirtualHost>
