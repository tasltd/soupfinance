# Apache Performance-Optimized Configuration for app.soupfinance.com
# Origin server: 65.20.112.224
# Optimized for static file serving (React SPA) - Nginx-like performance
#
# Key optimizations applied:
# 1. mpm_event module (event-driven, not process-forked)
# 2. AllowOverride None (no .htaccess filesystem lookups)
# 3. EnableSendfile On (kernel-level file transfer)
# 4. Brotli + GZIP compression
# 5. Aggressive caching headers for static assets
# 6. Tuned KeepAlive settings

# HTTP to HTTPS redirect
<VirtualHost *:80>
    ServerName app.soupfinance.com
    ServerAdmin admin@soupfinance.com

    # Redirect all HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

# HTTPS Virtual Host
<VirtualHost *:443>
    ServerName app.soupfinance.com
    ServerAdmin admin@soupfinance.com

    # Document root for SoupFinance SPA
    DocumentRoot /var/www/soupfinance

    # === PERFORMANCE: Disable .htaccess lookups ===
    # This eliminates 4+ filesystem lookups per request
    <Directory /var/www/soupfinance>
        Options -Indexes +FollowSymLinks

        # CRITICAL: AllowOverride None prevents .htaccess parsing
        AllowOverride None
        Require all granted

        # SPA routing - serve index.html for all non-file routes
        # (This replaces .htaccess rules)
        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            # Don't rewrite files or directories
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            # Rewrite everything else to index.html
            RewriteRule ^ index.html [L]
        </IfModule>

        # Alternative: FallbackResource (simpler, slightly faster)
        # FallbackResource /index.html
    </Directory>

    # === PERFORMANCE: Enable kernel-level file transfer ===
    EnableMMAP On
    EnableSendfile On

    # === COMPRESSION: Brotli (preferred) + GZIP fallback ===
    <IfModule mod_brotli.c>
        AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/xml text/css
        AddOutputFilterByType BROTLI_COMPRESS text/javascript application/javascript application/x-javascript
        AddOutputFilterByType BROTLI_COMPRESS application/json application/xml application/xhtml+xml
        AddOutputFilterByType BROTLI_COMPRESS application/rss+xml application/atom+xml
        AddOutputFilterByType BROTLI_COMPRESS image/svg+xml application/wasm
        # Compression level (0-11, default 6)
        BrotliCompressionQuality 6
    </IfModule>

    <IfModule mod_deflate.c>
        # GZIP fallback for browsers without Brotli support
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
        AddOutputFilterByType DEFLATE text/javascript application/javascript application/x-javascript
        AddOutputFilterByType DEFLATE application/json application/xml application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml application/atom+xml
        AddOutputFilterByType DEFLATE image/svg+xml application/wasm

        # Don't compress already-compressed files
        SetEnvIfNoCase Request_URI "\.(?:gif|jpe?g|png|webp|avif|ico|woff2?|ttf|eot|zip|gz|br)$" no-gzip

        # Compression level (1-9, default 6)
        DeflateCompressionLevel 6
    </IfModule>

    # === CACHING: Aggressive static asset caching ===
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresDefault "access plus 1 month"

        # HTML - no cache (SPA entry point, always fresh)
        ExpiresByType text/html "access plus 0 seconds"

        # Static assets - immutable (1 year, Vite adds hash to filenames)
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType text/javascript "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType application/x-javascript "access plus 1 year"

        # Fonts - 1 year
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType font/woff2 "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"
        ExpiresByType application/font-woff2 "access plus 1 year"
        ExpiresByType font/ttf "access plus 1 year"
        ExpiresByType font/otf "access plus 1 year"
        ExpiresByType application/x-font-ttf "access plus 1 year"

        # Images - 1 year
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/webp "access plus 1 year"
        ExpiresByType image/avif "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType image/x-icon "access plus 1 year"

        # JSON/XML - short cache
        ExpiresByType application/json "access plus 1 hour"
        ExpiresByType application/xml "access plus 1 hour"
    </IfModule>

    <IfModule mod_headers.c>
        # HTML - no cache, always revalidate
        <FilesMatch "\.html$">
            Header set Cache-Control "no-cache, no-store, must-revalidate"
            Header set Pragma "no-cache"
            Header set Expires "0"
        </FilesMatch>

        # Static assets - immutable (browser can cache forever)
        <FilesMatch "\.(js|css|woff2?|ttf|eot|otf)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>

        # Images - immutable
        <FilesMatch "\.(ico|gif|jpe?g|png|webp|avif|svg)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>

        # Security headers
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"

        # Vary header for proper caching with compression
        Header append Vary Accept-Encoding
    </IfModule>

    # === API PROXY: Route /rest/* and /client/* to Varnish/Tomcat ===
    ProxyPreserveHost On
    ProxyRequests Off

    # Proxy API calls to Varnish (port 6081) -> Tomcat (Grails backend)
    ProxyPass /rest/ http://127.0.0.1:6081/rest/
    ProxyPassReverse /rest/ http://127.0.0.1:6081/rest/

    ProxyPass /client/ http://127.0.0.1:6081/client/
    ProxyPassReverse /client/ http://127.0.0.1:6081/client/

    # === SSL CONFIGURATION ===
    # NOTE: Generate certificate before enabling:
    #   certbot certonly --standalone -d app.soupfinance.com
    #   systemctl restart apache2
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/app.soupfinance.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/app.soupfinance.com/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # === LOGGING ===
    ErrorLog ${APACHE_LOG_DIR}/soupfinance-error.log
    CustomLog ${APACHE_LOG_DIR}/soupfinance-access.log combined
</VirtualHost>
