# Apache Performance-Optimized Configuration for www.soupfinance.com Landing Page
# Origin server: 65.20.112.224
# Optimized for static file serving - Nginx-like performance
#
# Key optimizations applied:
# 1. AllowOverride None (no .htaccess filesystem lookups)
# 2. EnableSendfile On (kernel-level file transfer)
# 3. Brotli + GZIP compression
# 4. Aggressive caching headers for static assets
# 5. mod_expires for explicit cache control
#
# Domain routing:
# - soupfinance.com -> redirects to www.soupfinance.com
# - www.soupfinance.com -> serves landing page
# - app.soupfinance.com -> serves React app (separate vhost)

# HTTP Virtual Host - Redirect all to HTTPS
<VirtualHost *:80>
    ServerName soupfinance.com
    ServerAlias www.soupfinance.com
    ServerAdmin admin@soupfinance.com

    # Redirect all HTTP to HTTPS (www)
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://www.soupfinance.com%{REQUEST_URI} [L,R=301]
</VirtualHost>

# HTTPS - Redirect bare domain to www
<VirtualHost *:443>
    ServerName soupfinance.com
    ServerAdmin admin@soupfinance.com

    # Redirect bare domain to www
    RewriteEngine On
    RewriteRule ^ https://www.soupfinance.com%{REQUEST_URI} [L,R=301]

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/soupfinance.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/soupfinance.com/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>

# HTTPS - www.soupfinance.com Landing Page (Performance Optimized)
<VirtualHost *:443>
    ServerName www.soupfinance.com
    ServerAdmin admin@soupfinance.com

    # Document root for landing page
    DocumentRoot /var/www/soupfinance-landing

    # === PERFORMANCE: Disable .htaccess lookups ===
    # This eliminates 4+ filesystem lookups per request
    <Directory /var/www/soupfinance-landing>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # === PERFORMANCE: Enable kernel-level file transfer ===
    EnableMMAP On
    EnableSendfile On

    # === COMPRESSION: Brotli (preferred) + GZIP fallback ===
    <IfModule mod_brotli.c>
        AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/xml text/css
        AddOutputFilterByType BROTLI_COMPRESS text/javascript application/javascript application/x-javascript
        AddOutputFilterByType BROTLI_COMPRESS application/json application/xml application/xhtml+xml
        AddOutputFilterByType BROTLI_COMPRESS image/svg+xml
        # Compression level (0-11, default 6)
        BrotliCompressionQuality 6
    </IfModule>

    <IfModule mod_deflate.c>
        # GZIP fallback for browsers without Brotli support
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
        AddOutputFilterByType DEFLATE text/javascript application/javascript application/x-javascript
        AddOutputFilterByType DEFLATE application/json application/xml application/xhtml+xml
        AddOutputFilterByType DEFLATE image/svg+xml

        # Don't compress already-compressed files
        SetEnvIfNoCase Request_URI "\\.(?:gif|jpe?g|png|webp|ico|woff2?|ttf|eot|zip|gz|br)$" no-gzip

        # Compression level (1-9, default 6)
        DeflateCompressionLevel 6
    </IfModule>

    # === CACHING: Aggressive static asset caching ===
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresDefault "access plus 1 month"

        # HTML - no cache (always serve fresh landing page)
        ExpiresByType text/html "access plus 0 seconds"

        # Static assets - 1 year (immutable)
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType text/javascript "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"

        # Images - 1 year
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/webp "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType image/x-icon "access plus 1 year"

        # Fonts - 1 year
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType font/woff2 "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"
        ExpiresByType application/font-woff2 "access plus 1 year"
    </IfModule>

    <IfModule mod_headers.c>
        # HTML - no cache, always revalidate
        <FilesMatch "\\.html$">
            Header set Cache-Control "no-cache, no-store, must-revalidate"
            Header set Pragma "no-cache"
            Header set Expires "0"
        </FilesMatch>

        # Static assets - immutable (browser can cache forever)
        <FilesMatch "\\.(css|js|woff2?|ttf|eot|otf)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>

        # Images - immutable
        <FilesMatch "\\.(ico|gif|jpe?g|png|webp|svg)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>

        # Security headers
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"

        # Vary header for proper caching with compression
        Header append Vary Accept-Encoding
    </IfModule>

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/soupfinance.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/soupfinance.com/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/www-soupfinance-error.log
    CustomLog ${APACHE_LOG_DIR}/www-soupfinance-access.log combined
</VirtualHost>
